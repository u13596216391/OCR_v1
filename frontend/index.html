<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Pipeline Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-pending { background-color: #f59e0b; }
        .status-processing { background-color: #3b82f6; }
        .status-processed { background-color: #10b981; }
        .status-failed { background-color: #ef4444; }
        .status-corrected { background-color: #14b8a6; }
        /* 新增 'ingested' 状态样式 */
        .status-ingested { background-color: #8b5cf6; } /* 紫色 */

        .btn { padding: 8px 16px; border-radius: 6px; color: white; font-weight: 500; transition: background-color 0.2s; cursor: pointer; border: none; }
        .btn-primary { background-color: #3b82f6; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; }
        .btn-success:hover { background-color: #16a34a; }
        .btn-info { background-color: #0ea5e9; }
        .btn-info:hover { background-color: #0284c7; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app" v-cloak class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900">OCR 处理流程面板</h1>
        <p class="mt-2 text-lg text-gray-600">上传PDF -> 自动OCR -> 人工校对 -> 生成RAGFlow入库文件</p>
    </header>

    <!-- 文件上传区域 -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-semibold mb-4">第一步：上传PDF文档</h2>
        <div 
            @dragover.prevent="dragover = true" 
            @dragleave.prevent="dragover = false" 
            @drop.prevent="handleDrop"
            :class="{'border-blue-500 bg-blue-50': dragover, 'border-gray-300': !dragover}"
            class="border-2 border-dashed rounded-lg p-10 text-center cursor-pointer transition-colors"
            @click="$refs.fileInput.click()"
        >
            <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden" accept=".pdf">
            <p v-if="!fileToUpload" class="text-gray-500">将PDF文件拖拽到此处，或点击选择文件</p>
            <p v-else class="text-blue-700 font-medium">{{ fileToUpload.name }}</p>
        </div>
        <div class="mt-4 text-right">
            <button @click="submitFile" :disabled="!fileToUpload || isUploading" class="btn btn-primary" :class="{'opacity-50 cursor-not-allowed': !fileToUpload || isUploading}">
                {{ isUploading ? '上传中...' : '上传并开始处理' }}
            </button>
        </div>
    </div>

    <!-- 文档列表 -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-semibold mb-4">第二步：文档处理中心</h2>
        <div v-if="isLoading" class="text-center py-8">
            <p>加载文档列表中...</p>
        </div>
        <ul v-else class="space-y-4">
            <li v-for="doc in documents" :key="doc.id" class="p-4 border border-gray-200 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div class="flex-grow">
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="status-dot" :class="`status-${doc.status}`" :title="doc.status"></span>
                        <p class="font-mono text-sm text-gray-700 break-all">{{ getFileName(doc.original_pdf_path) }}</p>
                        
                        <span v-if="doc.raw_ocr_json" class="text-xs font-semibold text-sky-600 bg-sky-100 px-2 py-1 rounded-full">
                            OCR完成
                        </span>
                        
                        <span v-if="doc.corrected_label_studio_json" class="text-xs font-semibold text-teal-600 bg-teal-100 px-2 py-1 rounded-full">
                            校对已保存
                        </span>
                         <!-- 新增状态标签 -->
                        <span v-if="doc.status === 'ingested'" class="text-xs font-semibold text-violet-600 bg-violet-100 px-2 py-1 rounded-full">
                            RAGFlow文件已生成
                        </span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">上传于: {{ new Date(doc.created_at).toLocaleString() }}</p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <!-- 新增按钮 -->
                    <button @click="downloadRAGFlowPayload(doc.id)" :disabled="doc.status !== 'corrected' && doc.status !== 'ingested'" class="btn btn-success text-sm" :class="{'opacity-50 cursor-not-allowed': doc.status !== 'corrected' && doc.status !== 'ingested'}">
                        生成RAGFlow文件
                    </button>

                    <input type="file" :ref="`correctionFileInput_${doc.id}`" @change="handleCorrectionFileUpload($event, doc.id)" class="hidden" accept=".json">
                    <button @click="triggerCorrectionFileUpload(doc.id)" class="btn btn-info text-sm">
                        上传校对JSON
                    </button>
                    
                    <button @click="downloadRawOcrJson(doc.id)" :disabled="!isReadyForDownload(doc.status)" class="btn btn-secondary text-sm" :class="{'opacity-50 cursor-not-allowed': !isReadyForDownload(doc.status)}">
                        下载原始OCR JSON
                    </button>

                    <button @click="deleteDocument(doc.id)" class="btn btn-danger text-sm">删除</button>
                </div>
            </li>
        </ul>
    </div>
</div>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                documents: [],
                isLoading: true,
                isUploading: false,
                fileToUpload: null,
                dragover: false,
                pollInterval: null
            }
        },
        methods: {
            apiClient() { return axios.create({ baseURL: 'http://127.0.0.1:8000/api' }); },
            async fetchDocuments() {
                try {
                    const response = await this.apiClient().get('/documents/');
                    this.documents = response.data;
                } catch (error) { console.error('获取文档列表失败:', error); } 
                finally { this.isLoading = false; }
            },
            handleFileUpload(event) { this.fileToUpload = event.target.files[0]; },
            handleDrop(event) { this.fileToUpload = event.dataTransfer.files[0]; },
            async submitFile() {
                if (!this.fileToUpload) return;
                this.isUploading = true;
                const formData = new FormData();
                formData.append('file', this.fileToUpload);
                try {
                    await this.apiClient().post('/documents/upload/', formData);
                    this.fileToUpload = null;
                    await this.fetchDocuments();
                } catch (error) {
                    console.error('文件上传失败:', error);
                    alert('文件上传失败，请检查后端服务。');
                } finally { this.isUploading = false; }
            },
            async deleteDocument(docId) {
                if (!confirm('确定要删除这个文档吗？')) return;
                try {
                    await this.apiClient().delete(`/documents/${docId}/`);
                    await this.fetchDocuments();
                } catch (error) { console.error(`删除文档失败:`, error); }
            },
            // 新增 RAGFlow 文件下载方法
            async downloadRAGFlowPayload(docId) {
                try {
                    const response = await this.apiClient().get(`/documents/${docId}/to-ragflow/`, { responseType: 'blob' });
                    this.triggerFileDownload(response, 'ragflow_payload.json');
                    // 下载成功后，立即刷新列表以显示 'ingested' 状态
                    await this.fetchDocuments();
                } catch (error) {
                    this.handleDownloadError(error, '生成RAGFlow文件失败');
                }
            },
            async downloadRawOcrJson(docId) {
                try {
                    const response = await this.apiClient().get(`/documents/${docId}/to-label-studio/`, { responseType: 'blob' });
                    this.triggerFileDownload(response, 'raw_ocr.json');
                } catch (error) {
                    this.handleDownloadError(error, '下载原始OCR文件失败');
                }
            },
            triggerFileDownload(response, defaultFilename) {
                const contentDisposition = response.headers['content-disposition'];
                let filename = defaultFilename;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch.length > 1) filename = filenameMatch[1];
                }
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                link.remove();
                window.URL.revokeObjectURL(url);
            },
            handleDownloadError(error, baseMessage) {
                 console.error(`${baseMessage}:`, error);
                if (error.response && error.response.data) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const errorJson = JSON.parse(reader.result);
                            alert(`${baseMessage}: ${errorJson.error || '未知错误'}`);
                        } catch (e) { alert(`${baseMessage}，且无法解析错误信息。`); }
                    };
                    reader.readAsText(error.response.data);
                } else {
                    alert(`${baseMessage}，请检查网络和后端服务。`);
                }
            },
            triggerCorrectionFileUpload(docId) {
                this.$refs[`correctionFileInput_${docId}`][0].click();
            },
            async handleCorrectionFileUpload(event, docId) {
                const file = event.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                try {
                    await this.apiClient().post(`/documents/${docId}/submit-correction/`, formData);
                    alert('校对结果已成功上传！');
                    await this.fetchDocuments();
                } catch (error) {
                    const errorMsg = error.response?.data?.error || '上传失败。';
                    alert(`上传校对文件失败: ${errorMsg}`);
                } finally {
                    event.target.value = '';
                }
            },
            isReadyForDownload(status) {
                return ['processed', 'corrected', 'ingested'].includes(status);
            },
            getFileName(path) { return path ? path.split(/[\\/]/).pop() : 'N/A'; },
            startPolling() { this.pollInterval = setInterval(this.fetchDocuments, 5000); },
            stopPolling() { clearInterval(this.pollInterval); }
        },
        mounted() {
            this.fetchDocuments();
            this.startPolling();
        },
        beforeUnmount() { this.stopPolling(); }
    }).mount('#app')
</script>

</body>
</html>

